<!DOCTYPE html>
<html>
<body>

<canvas id="FrontCanvas" width="615" height="2414" style="border:2px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>

<canvas id="DeflectionCanvas" width="615" height="615" style="border:2px solid #d3d3d3; position:absolute; top:1200px; left:650px;">
Your browser does not support the HTML5 canvas tag.</canvas>
    
<label style="z-index:101; position:absolute; top:10px; left:650px;">  <p style="font-size:20px">Cathode parameters</p></label>
<label style="z-index:101; position:absolute; top:60px; left:650px;">  <input type=number id = "CathR" style="width: 7ch" value="20" oninput="DrawGun()"> mm &nbsp; Cath R</label>
<label style="z-index:101; position:absolute; top:85px; left:650px;">  <input type=number id = "CathFocusR" style="width: 7ch" value="42" oninput="DrawGun()"> mm &nbsp; Cath focus R</label>
<label style="z-index:101; position:absolute; top:110px; left:650px;"> <input type=number id = "CathSkirtR" style="width: 7ch" value="3" oninput="DrawGun()"> mm &nbsp; Cath skirt thickness</label>
<label style="z-index:101; position:absolute; top:135px; left:650px;"> <input type=number id = "CathSkirtH" style="width: 7ch" value="3" step = "1" oninput="DrawGun()"> mm &nbsp; Cath skirt H</label>
<label style="z-index:101; position:absolute; top:160px; left:650px;"> <input type=number id = "CathSkirtA" style="width: 7ch" value="60" step = "5" oninput="DrawGun()"> mm &nbsp; Cath skirt angle</label>
<label style="z-index:101; position:absolute; top:185px; left:650px;"> <input type=number id = "CathButtA" style="width: 7ch" value="90" step = "1" oninput="DrawGun()"> mm &nbsp; Cath butt angle</label>

<label style="z-index:101; position:absolute; top:200px; left:650px;"> <p style="font-size:20px">Anode parameters</p></label>
<label style="z-index:101; position:absolute; top:250px; left:650px;"> <input type=number id = "AnodeCathGap" style="width: 7ch" value="4" oninput="DrawGun()"> mm &nbsp; Anode/cath gap </label>
<label style="z-index:101; position:absolute; top:275px; left:650px;"> <input type=number id = "AnodeInnerR" style="width: 7ch" value="22" oninput="DrawGun()"> mm &nbsp; Anode inner R</label>
<label style="z-index:101; position:absolute; top:300px; left:650px;"> <input type=number id = "AnodeRadialGap" style="width: 7ch" step = "0.5" value="5" oninput="DrawGun()"> mm &nbsp; Radial gap</label>
<label style="z-index:101; position:absolute; top:325px; left:650px;"> <input type=number id = "AnodeSaddleH" style="width: 7ch" value="5" oninput="DrawGun()"> mm &nbsp; Anode saddle h</label>
<label style="z-index:101; position:absolute; top:350px; left:650px;"> <input type=number id = "AnodeCurvH" style="width: 7ch" value="34" oninput="DrawGun()"> mm &nbsp; Anode curve h</label>
<label style="z-index:101; position:absolute; top:375px; left:650px;"> <input type=number id = "AnodeNozzleR" style="width: 7ch" value="12" oninput="DrawGun()"> mm &nbsp; Anode nozzle R</label>
<label style="z-index:101; position:absolute; top:400px; left:650px;"> <input type=number id = "AnodeNozzleH" style="width: 7ch" value="6" oninput="DrawGun()"> mm &nbsp; Anode nozzle h</label>
<label style="z-index:101; position:absolute; top:425px; left:650px;"> <input type=number id = "AnodeNozzleThroatR" style="width: 7ch" value="6" oninput="DrawGun()"> mm &nbsp; Anode throat R</label>
<label style="z-index:101; position:absolute; top:450px; left:650px;"> <input type=number id = "AnodeNozzleThroatH" style="width: 7ch" value="2" oninput="DrawGun()"> mm &nbsp; Anode throat h</label>
<label style="z-index:101; position:absolute; top:475px; left:650px;"> <input type=number id = "AnodeNozzleDiffusorR" style="width: 7ch" value="13" oninput="DrawGun()"> mm &nbsp; Anode nozzle diffusor R</label>
<label style="z-index:101; position:absolute; top:500px; left:650px;"> <input type=number id = "AnodeNozzleDiffusorH" style="width: 7ch" value="9" oninput="DrawGun()"> mm &nbsp; Anode nozzle diffusor h</label>

<label style="z-index:101; position:absolute; top:10px; left:950px;"> <p style="font-size:20px">Superfish parameters</p></label>
<label style="z-index:101; position:absolute; top:60px; left:950px;"> <input type=number id = "SFFocusX" style="width: 7ch; color: #b9b8b8" readonly> cm &nbsp; Focus x </label>
<label style="z-index:101; position:absolute; top:90px; left:950px;"> <input type=number id = "SFFocusY" style="width: 7ch; color: #b9b8b8" readonly> cm &nbsp; Focus y </label>
<label style="z-index:101; position:absolute; top:120px; left:950px;"> <input type=number id = "SFBeamHalfAngle" style="width: 7ch; color: #b9b8b8" readonly> rad &nbsp; Beam half angle </label>
<label style="z-index:101; position:absolute; top:150px; left:950px;"> <input type=number id = "SFIntGran" style="width: 7ch" value="50"> itms &nbsp; Field interp gran (7.5cm/x)</label>

<label style="z-index:101; position:absolute; top:200px; left:950px;"> <p style="font-size:20px">Discharge parameters</p></label>
<label style="z-index:101; position:absolute; top:250px; left:950px;"> <input type=number id = "CathDarkSpace" style="width: 7ch" value="16" oninput="DrawGun()"> mm &nbsp; Cathode dark space </label>
<label style="z-index:101; position:absolute; top:275px; left:950px;"> <input type=number id = "AccelerationVoltage" style="width: 7ch" value="10000" step = "1000" oninput="DrawGun()"> V &nbsp; Acceleration voltage </label>
<label style="z-index:101; position:absolute; top:300px; left:950px;"> <input type=number id = "SpaceCharge" style="width: 8ch" value="0.55e-9" step="1e-10" oninput="DrawGun()"> Coul/cm^3 &nbsp; Space charge </label>
<label style="z-index:101; position:absolute; top:325px; left:950px;"> <input type=number id = "SpaceChargeGap" style="width: 7ch" value="10" step="1" oninput="DrawGun()"> mm &nbsp; Space charge gap </label>
<label style="z-index:101; position:absolute; top:350px; left:950px;"> <input type=number id = "StartingEnergy" style="width: 7ch" value="20" step="1" oninput="DrawGun()"> eV &nbsp; Starting energy </label>
<div style="z-index:101; position:absolute; top:380px; left:950px;">
    <input type="checkbox" id="SweepCDS">
    <label>Sweep 6-26</label>
</div>

<div style="z-index:101; position:absolute; top:405px; left:950px;">
    <input type="checkbox" id="SoundOnCompletion" checked>
    <label>Sound on completion</label>
</div>


<label style="z-index:101; position:absolute; top:420px; left:950px;"> <p style="font-size:20px">Profiles</p></label>
<table style="z-index:101; position:absolute; top:470px; left:950px;">
    <tr>
        <td colspan="3">
            <select id="GunParams" class="REST" name="GunParams" onchange="onRESTSelect(this.value)" style="width: 250px"></select>
        </td>
    </tr>
    <tr>
        <td>
            <button type="button" class="REST" onclick="onRESTAdd()" style="width: 80px">Save to...</button>
        </td>
        <td>
            <button type="button" class="REST" onclick="onRESTUpdate()" style="width: 80px">Update</button>
        </td>
        <td>
            <button type="button" class="REST" onclick="onRESTDelete()"  style="width: 80px">Delete</button>
        </td>
    </tr>
</table>


<div style="z-index:101; position:absolute; top:570px; left:1160px;">
        <input type="checkbox" id="UsePrecalcFields" name="UsePrecalcFields" title="Skip fields calculation" value="UsePrecalcFields">
        <label for="UsePrecalcFields">Use precalc fields</label>
</div>

<div style="z-index:101; position:absolute; top:635px; left:1080px;">
        <input type="checkbox" id="PlotFields" name="PlotFields" title="Render calculated ES/MS field" value="PlotFields">
        <label for="PlotFields">Plot fields</label>
</div>

<div style="z-index:101; position:absolute; top:570px; left:660px;">
        <input type="checkbox" id="CalcESField" name="CalcESField" title="Calculate ES field" value="CalcESField">
        <label for="CalcESField">Electrostatic</label>
</div>
<div style="z-index:101; position:absolute; top:635px; left:660px;">
        <input type="checkbox" id="CalcMSField" name="CalcMSField" title="Calculate MS field" value="CalcMSField">
        <label for="CalcMSField">Magnetostatic</label>
</div>
<div style="z-index:101; position:absolute; top:660px; left:660px;">
    <input type="checkbox" id="CalcDSField" name="CalcDSField" title="Calculate Deflection field" value="CalcDSField">
    <label for="CalcDSField">Deflection</label>
</div>


<div style="z-index:101; position:absolute; top:635px; left:1245px;">
    <input type="radio" id="ParticleElectron" name="ParticleSelector" title="Trace electron flow" checked>
    <label for="ParticleSelector">Electrons</label><br>
    <input type="radio" id="ParticleIon" name="ParticleSelector" title="Trace ion flow">
    <label for="ParticleSelector">Ions</label>
</div>

<table style="z-index:101; position:absolute; top:600px; left:670px;">
    <tr>
        <td><img id="loadingImg" src='/Media/loading.gif' height="20" width ="20" style="display: none"></td>
        <td><form id="postEStaticData"> <input id="CalcButton" type="submit" value="Calculate"> </form></td>
        <td> <span id="SrvrOnline">Server online </span> </td>
        <td>→</td>
        <td> <div id="SrvrAM">AutoMesh</div></td>
        <td>→</td>
        <td> <div id="SrvrPoisson">Poisson</div></td>
        <td>→</td>
        <td> <div id="SrvrSF7">SF7</div></td>
        <td>→</td>
        <td> <div id="SrvrWSFPlot">WSFPlot</div></td>
        <td>→</td>
        <td> <div id="SrvrEFRead">Field read</div> </td>
        <td>→</td>
        <td> <div id="SrvrElectron">Trace</div></td>
    </tr>
</table>

<div class="bevelBox"style="z-index:100; position:absolute; top:560px; left:650px; width:690px; height:130px; border: 1px solid #808080;"></div>

<label style="z-index:101; position:absolute; top:700px; left:650px;"> <p style="font-size:20px">Focusing lens #1</p></label>
<label style="z-index:101; position:absolute; top:750px; left:650px;"> <input type=number id = "Lens1DistToGun" style="width: 7ch" value="30" oninput="DrawGun()"> mm &nbsp; Dist to gun</label>
<label style="z-index:101; position:absolute; top:775px; left:650px;"> <input type=number id = "Lens1InnerR" style="width: 7ch" value="50" oninput="DrawGun()"> mm &nbsp; Coil inner R</label>
<label style="z-index:101; position:absolute; top:800px; left:650px;"> <input type=number id = "Lens1Thickness" style="width: 7ch" value="10" oninput="DrawGun()"> mm &nbsp; Coil thickness</label>
<label style="z-index:101; position:absolute; top:825px; left:650px;"> <input type=number id = "Lens1Height" style="width: 7ch" value="25" oninput="DrawGun()"> mm &nbsp; Coil height </label>
<label style="z-index:101; position:absolute; top:850px; left:650px;"> <input type=number id = "Lens1TotCurrent" style="width: 7ch" value="2500" step = "100" oninput="DrawGun()"> A*N &nbsp; Coil total current</label>
<label style="z-index:101; position:absolute; top:875px; left:650px;"> <input type=number id = "Lens1CoreThickness" style="width: 7ch" value="0" oninput="DrawGun()"> mm &nbsp; Core thickness</label>

<label style="display: none; z-index:101; position:absolute; top:700px; left:950px;"> <p style="font-size:20px">Focusing lens #2</p></label>
<label style="display: none; z-index:101; position:absolute; top:750px; left:950px;"> <input type=number id = "Lens2DistToGun" style="width: 7ch" value="85" oninput="DrawGun()"> mm &nbsp; Dist to gun</label>
<label style="display: none; z-index:101; position:absolute; top:775px; left:950px;"> <input type=number id = "Lens2InnerR" style="width: 7ch" value="25" oninput="DrawGun()"> mm &nbsp; Coil inner R</label>
<label style="display: none; z-index:101; position:absolute; top:800px; left:950px;"> <input type=number id = "Lens2Thickness" style="width: 7ch" value="20" oninput="DrawGun()"> mm &nbsp; Coil thickness</label>
<label style="display: none; z-index:101; position:absolute; top:825px; left:950px;"> <input type=number id = "Lens2Height" style="width: 7ch" value="25" oninput="DrawGun()"> mm &nbsp; Coil height </label>
<label style="display: none; z-index:101; position:absolute; top:850px; left:950px;"> <input type=number id = "Lens2TotCurrent" style="width: 7ch" value="0" step = "100" oninput="DrawGun()"> A*N &nbsp; Coil total current</label>
<label style="display: none; z-index:101; position:absolute; top:875px; left:950px;"> <input type=number id = "Lens2CoreThickness" style="width: 7ch" value="5" oninput="DrawGun()"> mm &nbsp; Core thickness</label>

<label style="z-index:101; position:absolute; top:900px; left:650px;"> <p style="font-size:20px">Deflection coil</p></label>
<label style="z-index:101; position:absolute; top:950px; left:650px;"> <input type=number id = "DeflAbsPosY" style="width: 7ch; color: #b9b8b8" readonly> cm &nbsp;&nbsp; Absolute position Y </label>
<label style="z-index:101; position:absolute; top:975px; left:650px;"> <input type=number id = "DeflCoilDistToGun" style="width: 7ch" value="130" oninput="DrawGun()"> mm &nbsp; Dist to gun</label>
<label style="z-index:101; position:absolute; top:1000px; left:650px;"> <input type=number id = "DeflCoilHeight" style="width: 7ch" value="25" oninput="DrawGun()"> mm &nbsp; Coil height </label>
<label style="z-index:101; position:absolute; top:1025px; left:650px;"> <input type=number id = "DeflCoilTotCurrent" style="width: 7ch" value="100" step = "10" oninput="DrawGun()"> A*N &nbsp; Coil total current</label>


<a href="#" id="btn-download" onclick="downloadImage()">Download image</a>

<br>

<textarea id = "ElectrostaticTextArea" rows = "30" cols = "85">Your text here</textarea>
<textarea id = "MagnetostaticTextArea" rows = "30" cols = "85">Your text here</textarea>
<textarea id = "DeflectionTextArea" rows = "30" cols = "85">Your text here</textarea>


<img src="/Media/Stubs/131.png" id="ElectronImage" alt="Girl in a jacket" width="646" height="2382" style="mix-blend-mode: multiply; position:absolute; top:-28px; left:-28px;">

<script>

    function downloadImage(){
        document.getElementById("btn-download").download = "image.png";
        document.getElementById("btn-download").href = document.getElementById("FrontCanvas").toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
    }

    var _beep = new window.Audio("/Media/01 Rom Test.mp3");
    function playBeep() { _beep.play()};
    
    var timer = false;
    var CSD = 6;

    var $ = function( id ) { return document.getElementById( id ); };
    var $F = function( id ) { return parseFloat(document.getElementById( id ).value); };

    var bOnce;
    var bCommIgnore = false;

    function ClearServerCaptions()
    {
        $('SrvrAM').style.color = "Black";
        $('SrvrPoisson').style.color = "Black";
        $('SrvrSF7').style.color = "Black";
        $('SrvrWSFPlot').style.color = "Black";
        $('SrvrEFRead').style.color = "Black";
        $('SrvrElectron').style.color = "Black";
    }

    $('postEStaticData').addEventListener('submit', postEStaticData);

    function postEStaticData(event) {
           event.preventDefault();

           bOnce = true;
           bCommIgnore = true;

           ClearServerCaptions();

           EnableRESTgui(false);
         
           let CathDarkSpace = $F('AnodeCathGap')/10.0 + $F('CathDarkSpace')/10.0; // convert to cm    

        //    if (($("UsePrecalcFields").checked) && (!window.confirm("Use precalc field?")))
        //    {
        //        bOnce = false;
        //        return;
        //    }

           // check if user asked to do automatic cathode dark space sweep
           if (($("SweepCDS").checked) && (timer === false))
           {
              timer = setInterval(function()
              {
                if (!document.getElementById("CalcButton").disabled)
                {
                    console.log('Next iteration');
                    document.getElementById("CathDarkSpace").value++;
                    DrawGun();

                    if (document.getElementById("CathDarkSpace").value >= 26)
                    {
                        clearInterval(timer);
                        timer = false;
                    }

                    document.getElementById("CalcButton").click();   
                }    
              }, 2000);
           }

           fetch('http://127.0.0.1:3000/calculate', {
               method  : 'POST',
               headers : new Headers({'content-type': 'application/json'}),
               body    : JSON.stringify({   "SuperfishParams": {
                                                "SFIntGran"        : $F('SFIntGran'),
                                                "AutofishES"       : $('ElectrostaticTextArea').value, // text
                                                "AutofishMS"       : $('MagnetostaticTextArea').value, // text
                                                "AutofishDS"       : $('DeflectionTextArea').value,    // text
                                                "UsePrecalcFields" : $("UsePrecalcFields").checked,    // bool
                                                "PlotFields"       : $("PlotFields").checked,          // bool
                                                "TraceElectron"    : $("ParticleElectron").checked,    // bool
                                                "CalcESField"      : $("CalcESField").checked,         // bool
                                                "CalcMSField"      : $("CalcMSField").checked,         // bool
                                                "CalcDSField"      : $("CalcDSField").checked},        // bool
                                            "CathodeParams": {
                                                "CathR"            : $F('CathR'),
                                                "CathFocusR"       : $F('CathFocusR')/10.0,     // convert to cm
                                                "SFBeamHalfAngle"  : $F('SFBeamHalfAngle'),     // calculated
                                                "SFFocusX"         : $F('SFFocusX'),            // calculated
                                                "SFFocusY"         : $F('SFFocusY'),            // calculated
                                                "CathSkirtR"       : $F('CathSkirtR'),
                                                "CathSkirtH"       : $F('CathSkirtH'),
                                                "CathSkirtA"       : $F('CathSkirtA'),
                                                "CathButtA"        : $F('CathButtA')},
                                            "AnodeParams": {
                                                "AnodeCathGap"         : $F('AnodeCathGap'),
                                                "AnodeInnerR"          : $F('AnodeInnerR'),
                                                "AnodeRadialGap"       : $F('AnodeRadialGap'),
                                                "AnodeSaddleH"         : $F('AnodeSaddleH'),
                                                "AnodeCurvH"           : $F('AnodeCurvH'),
                                                "AnodeNozzleR"         : $F('AnodeNozzleR'),
                                                "AnodeNozzleH"         : $F('AnodeNozzleH'),
                                                "AnodeNozzleThroatR"   : $F('AnodeNozzleThroatR'),
                                                "AnodeNozzleThroatH"   : $F('AnodeNozzleThroatH'),
                                                "AnodeNozzleDiffusorR" : $F('AnodeNozzleDiffusorR'),
                                                "AnodeNozzleDiffusorH" : $F('AnodeNozzleDiffusorH')},
                                            "PlasmaParams": {
                                                "CathDarkSpace"        : CathDarkSpace,
                                                "AccelerationVoltage"  : $F('AccelerationVoltage'),
                                                "SpaceCharge"          : $F('SpaceCharge'),
                                                "SpaceChargeGap"       : $F('SpaceChargeGap'),
                                                "StartingEnergy"       : $F('StartingEnergy')},
                                            "Lens1Params": {
                                                "Lens1DistToGun"       : $F('Lens1DistToGun'),
                                                "Lens1InnerR"          : $F('Lens1InnerR'),
                                                "Lens1Thickness"       : $F('Lens1Thickness'),
                                                "Lens1Height"          : $F('Lens1Height'),
                                                "Lens1TotCurrent"      : $F('Lens1TotCurrent'),
                                                "Lens1CoreThickness"   : $F('Lens1CoreThickness') },
                                            "Lens2Params": {
                                                "Lens2DistToGun"       : $F('Lens2DistToGun'),
                                                "Lens2InnerR"          : $F('Lens2InnerR'),
                                                "Lens2Thickness"       : $F('Lens2Thickness'),
                                                "Lens2Height"          : $F('Lens2Height'),
                                                "Lens2TotCurrent"      : $F('Lens2TotCurrent'),
                                                "Lens2CoreThickness"   : $F('Lens2CoreThickness') },
                                            "DeflCoilParams": {
                                                "DeflCoilDistToGun"    : $F('DeflCoilDistToGun'),
                                                "DeflAbsPosY"          : $F('DeflAbsPosY'),           // calculated
                                                "DeflCoilHeight"       : $F('DeflCoilHeight'),
                                                "DeflCoilTotCurrent"   : $F('DeflCoilTotCurrent') }
                                        }),
               //mode    : 'cors'
           })
           .then((res)  => res.text())
           .then((data) => {console.log(data); bCommIgnore = false;})
           .catch((err) => console.log(err))
       }

</script>

<script type="text/javascript" src="EGun.js"> </script>
<script type="text/javascript" src="MGun.js"> </script>
<script type="text/javascript" src="DGun.js"> </script>

<script>
    function DrawGun()
    {
        DrawGunElectrostatic();
        DrawGunMagnetostatic();
        DrawGunDeflection();
    }

    DrawGun();
</script>

<script>

    function EnableRESTgui(flag) {
        $("CalcButton").disabled = !flag;

        var d = document.getElementsByClassName("REST");
        for (var i=0; i<d.length; i++) {
            d[i].disabled = !flag;
        }   
    }

    var ServerEnum = {
        OFFLINE  : 0,
        ONLINE   : 1,
        STARTING : 2,
        AUTOMESH : 3,
        POISSON  : 4,
        SF7      : 5,
        WSFPlot  : 6,
        EFRead   : 7,
        Electron : 8
    }
    
    var evtSource = new EventSource('http://127.0.0.1:3000/status');

    evtSource.onmessage = function(e) {
    
        if (bCommIgnore) return;

        console.log(e.data);
        var obj = JSON.parse(e.data);


        if (obj.state === ServerEnum.ONLINE)
        {
            $('SrvrOnline').style.color = "ForestGreen";
            $('loadingImg').style.display = 'none';
            EnableRESTgui(true);         
        }
        if (obj.state === ServerEnum.STARTING)
            $('loadingImg').style.display = 'block';
        if (obj.state >= ServerEnum.AUTOMESH)
            $('SrvrAM').style.color = "ForestGreen";
        if (obj.state >= ServerEnum.POISSON)
            $('SrvrPoisson').style.color = "ForestGreen";
        if (obj.state >= ServerEnum.SF7)
            $('SrvrSF7').style.color = "ForestGreen";
        if (obj.state >= ServerEnum.WSFPlot)
            $('SrvrWSFPlot').style.color = "ForestGreen";
        if (obj.state >= ServerEnum.EFRead)
            $('SrvrEFRead').style.color = "ForestGreen";
        if (obj.state >= ServerEnum.Electron)
        {

            if (bOnce) // play once
            {
                var d = new Date();
                document.getElementById("ElectronImage").src = "http://127.0.0.1:3000/image" + "?" + d.getTime();

                if ($("SoundOnCompletion").checked) playBeep();
                bOnce = false;
            }
    
            $('SrvrElectron').style.color = "ForestGreen";
            $('loadingImg').style.display = 'none';
            
            EnableRESTgui(true);
        }

    }
    evtSource.onopen = function(e) {
        console.log('SSE connection established');
    }
    evtSource.onerror = function(e) {
        console.log('SSE connection lost');

        $('SrvrOnline').style.color = "Black";
        ClearServerCaptions();
        $('loadingImg').style.display = 'none';
        EnableRESTgui(false);
    }

</script>

<script>

    function PrepareJSONdescriptor()
    {
        return {
            "CathodeParams": {
                "CathR"                : $F('CathR'),
                "CathFocusR"           : $F('CathFocusR'),
                "SFBeamHalfAngle"      : $F('SFBeamHalfAngle'),   // calculated
                "SFFocusX"             : $F('SFFocusX'),          // calculated
                "SFFocusY"             : $F('SFFocusY'),          // calculated
                "CathSkirtR"           : $F('CathSkirtR'),
                "CathSkirtH"           : $F('CathSkirtH'),
                "CathSkirtA"           : $F('CathSkirtA'),
                "CathButtA"            : $F('CathButtA')},
            "AnodeParams": {
                "AnodeCathGap"         : $F('AnodeCathGap'),
                "AnodeInnerR"          : $F('AnodeInnerR'),
                "AnodeRadialGap"       : $F('AnodeRadialGap'),
                "AnodeSaddleH"         : $F('AnodeSaddleH'),
                "AnodeCurvH"           : $F('AnodeCurvH'),
                "AnodeNozzleR"         : $F('AnodeNozzleR'),
                "AnodeNozzleH"         : $F('AnodeNozzleH'),
                "AnodeNozzleThroatR"   : $F('AnodeNozzleThroatR'),
                "AnodeNozzleThroatH"   : $F('AnodeNozzleThroatH'),
                "AnodeNozzleDiffusorR" : $F('AnodeNozzleDiffusorR'),
                "AnodeNozzleDiffusorH" : $F('AnodeNozzleDiffusorH')},
            "PlasmaParams": {
                "CathDarkSpace"        : $F('CathDarkSpace'),
                "AccelerationVoltage"  : $F('AccelerationVoltage'),
                "SpaceCharge"          : $F('SpaceCharge'),
                "SpaceChargeGap"       : $F('SpaceChargeGap'),
                "StartingEnergy"       : $F('StartingEnergy')},
            "Lens1Params": {
                "Lens1DistToGun"       : $F('Lens1DistToGun'),
                "Lens1InnerR"          : $F('Lens1InnerR'),
                "Lens1Thickness"       : $F('Lens1Thickness'),
                "Lens1Height"          : $F('Lens1Height'),
                "Lens1TotCurrent"      : $F('Lens1TotCurrent'),
                "Lens1CoreThickness"   : $F('Lens1CoreThickness') },
            "Lens2Params": {
                "Lens2DistToGun"       : $F('Lens2DistToGun'),
                "Lens2InnerR"          : $F('Lens2InnerR'),
                "Lens2Thickness"       : $F('Lens2Thickness'),
                "Lens2Height"          : $F('Lens2Height'),
                "Lens2TotCurrent"      : $F('Lens2TotCurrent'),
                "Lens2CoreThickness"   : $F('Lens2CoreThickness') },
            "DeflCoilParams": {
                "DeflCoilDistToGun"    : $F('DeflCoilDistToGun'),
                "DeflCoilHeight"       : $F('DeflCoilHeight'),
                "DeflCoilTotCurrent"   : $F('DeflCoilTotCurrent') }
                }
    }


    function JSONtoGUI(item)
    {
        for (var param in item.CathodeParams)
            $(param).value = item.CathodeParams[param];
        for (var param in item.AnodeParams)
            $(param).value = item.AnodeParams[param];
        for (var param in item.PlasmaParams)
            $(param).value = item.PlasmaParams[param];
        for (var param in item.Lens1Params)
            $(param).value = item.Lens1Params[param];
        for (var param in item.Lens2Params)
            $(param).value = item.Lens2Params[param];
        for (var param in item.DeflCoilParams)
            $(param).value = item.DeflCoilParams[param];

        DrawGun();
    }

    function onRESTAdd() {
        var profileName = prompt("Please, enter the name of the gun profile");
        if ((profileName === null) || (profileName === "")) return;

        var descriptor = PrepareJSONdescriptor();
        descriptor.name = profileName;

        fetch('http://127.0.0.1:3000/ODM/add', {
               method  : 'POST',
               headers : new Headers({'content-type': 'application/json'}),
               body    : JSON.stringify( descriptor ),
               //mode    : 'cors'
           })
           .then((res)  => {
               if (!res.ok) {
                   res.json().then(data => { console.log(data); return;}); }
               else {
                   res.json().then((data) => {
                        console.log(data);
                    
                        // Create an Option object       
                        var opt = document.createElement("option");        

                        // Assign text and value to Option object
                        opt.text = profileName;
                        opt.value = data.id;

                        $('GunParams').options.add(opt);
                        $('GunParams').value = data.id;
                    });
                }
            })
           .catch((err) => console.log(err));

    }

    function onRESTUpdate() {
        var selector = $('GunParams');
        if (selector.SelectedIndex < 0) return; // check for empty dropdown list

        var descriptor = PrepareJSONdescriptor();

        var id_local  = selector.options[selector.selectedIndex].value;

        fetch('http://127.0.0.1:3000/ODM/update/' + id_local, {
               method  : 'PATCH',
               headers : new Headers({'content-type': 'application/json'}),
               body    : JSON.stringify( descriptor ),
               //mode    : 'cors'
           })
           .then((res)  => {
                if (!res.ok) {
                    res.json().then(data => { console.log(data); return;});
                }
                else {
                    res.json().then(data => { 
                        console.log(data); });
                        window.alert("Updated successfully");
                }
            })
            .catch((err) => console.log(err));
    }

    function onRESTSelect(value) {

        fetch('http://127.0.0.1:3000/ODM/query/' + value, {
               method  : 'GET',
               //mode    : 'cors'
            })
            .then((res)  => {
                if (!res.ok) {
                    res.json().then(data => { console.log(data); return;}); }
                else {
                    res.json().then((data) => {
                        console.log(data);

                        JSONtoGUI(data);                     // load data into GUI
                    });
                }
            })
           .catch((err) => console.log(err));
    }

    function onRESTDelete() {

        var selector = $('GunParams');
        if (selector.selectedIndex < 0) return; // check for empty dropdown list

        if (!window.confirm("Gun profile will be deleted")) return;

        var id_local  = selector.options[selector.selectedIndex].value;

        fetch('http://127.0.0.1:3000/ODM/delete/' + id_local, {
            method  : 'DELETE',
            //mode    : 'cors'
            })
            .then((res)  => {
                if (!res.ok) {
                    res.json().then(data => { console.log(data); return; });
                }
                else {
                    res.json().then(data => { 
                        console.log(data); 
                        selector.remove(selector.selectedIndex);

                        window.alert("Deleted successfully");

                        if (selector.selectedIndex >= 0) {
                            onRESTSelect(selector.options[selector.selectedIndex].value);
                        }
                    });
                }
            })
            .catch((err) => console.log(err));
    }

    function populate() {
        fetch('http://127.0.0.1:3000/ODM/queryall', {
               method  : 'GET',
               //mode    : 'cors'
           })
           .then((res)  => res.json())
           .then((data) => {
                console.log(data);

                data.forEach(value => {
                    // Create an Option object       
                    var opt = document.createElement("option");        

                    // Assign text and value to Option object
                    opt.text = value.name;
                    opt.value = value._id;

                    $('GunParams').options.add(opt);
                })

                if (data.length > 0) {
                    JSONtoGUI(data[data.length-1]);                     // load data into GUI
                    $('GunParams').value = data[data.length-1]._id;     // select the last egun
                }
            })
           .catch((err) => console.log(err));
    }

    populate();
</script>

</body>
</html>
